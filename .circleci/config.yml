version: 2
jobs:
  test:
    docker:
      - image: hostedgraphite/pythonbuild:hgapp_dep_xenial
    steps:
      - checkout
      - run: apt-get update
      - run: apt-get install -y libpq-dev lm-sensors
      - run: pip install -r .travis.requirements.txt
      - run: pip install coverage
      - run: make install
      - run: coverage run --source=diamond test.py
      - save_cache:
          key: dep-pip-{{ .Branch }}-{{ checksum ".travis.requirements.txt" }}
          paths:
            - "/root/.cache"
  build:
    docker:
      - image: hostedgraphite/pythonbuild:hgapp_dep_xenial
    environment:
      CIRCLE_ARTIFACTS: /tmp/artifacts
    steps:
      - checkout
      - restore_cache:
          keys:
            - dep-pip-{{ .Branch }}-{{ checksum ".travis.requirements.txt" }}
      - run: mkdir -p $CIRCLE_ARTIFACTS
      - run: apt-get update
      - run: apt-get install -y libpq-dev lm-sensors python-configobj python-mock cdbs
      - run: pip install -r .travis.requirements.txt
      - run: make deb
      - run: cp build/*.deb $CIRCLE_ARTIFACTS
      - store_artifacts:
          path: /tmp/artifacts
      - save_cache:
          paths:
            - /tmp/artifacts/
          key: Diamond-{{ .Branch }}-{{ .Revision }}

workflows:
  version: 2
  default:
    jobs:
      - test
      - build
